<!DOCTYPE html>
<html class="writer-html5" lang="vi" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ngắt Ngoại vi GPIO - External Interrupt GPIO &mdash; Tài liệu zephyr_tutorial </title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d3888072"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/translations.js?v=71464233"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="../search.html" />
    <link rel="next" title="Ngắt UART" href="uart_interrupt.html" />
    <link rel="prev" title="Giới thiệu về Ngắt - Interrupt" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            zephyr_tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1.zephyr-setup/index.html">Cài đặt Zephyr cho máy tính</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.introduction/index.html">Giới thiệu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3.GPIO/index.html">GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4.Timers/index.html">Lesson 4: Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.UART/index.html">UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.I2C/index.html">I2C</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Giới thiệu về Ngắt - Interrupt</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#tong-quat">Tổng quát</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ngat-trong-zephyr-interrupt-api-zephyr">Ngắt trong Zephyr - Interrupt API Zephyr</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#cac-loai-ngat-trong-zephyr">Các loại Ngắt trong Zephyr</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#bang-vector-ngat-cua-zephyr">Bảng Vector Ngắt của Zephyr</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ngat-thong-thuong-regular-interrupt">Ngắt Thông thường - Regular Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ngat-truc-tiep-direct-interrupt">Ngắt Trực tiếp - Direct Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ngat-co-do-tre-bang-0-zero-latency-interrupt">Ngắt có độ trễ bằng 0 - Zero Latency Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ung-dung-ngat-ngoai-vi-gpio">Ứng dụng - Ngắt Ngoại vi - GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ung-dung-ngat-timer">Ứng dụng - Ngắt Timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#ung-dung-ngat-uart">Ứng dụng - Ngắt UART</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#vo-hieu-hoa-mot-ngat">Vô hiệu hóa một Ngắt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#cac-api-thuong-gap">Các API thường gặp</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#thuc-hanh">Thực hành</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#lien-ket">Liên kết</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Ngắt Ngoại vi GPIO - External Interrupt GPIO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tom-tat-phan-cung">Tóm tắt phần cứng</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tong-quan-ve-gpio">Tổng quan về GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#phan-tich-device-tree">Phân tích Device Tree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cac-cau-truc-du-lieu-lien-quan-den-devicetree">Các cấu trúc dữ liệu liên quan đến DeviceTree</a></li>
<li class="toctree-l4"><a class="reference internal" href="#khoi-tao-thiet-bi">Khởi tạo thiết bị</a></li>
<li class="toctree-l4"><a class="reference internal" href="#su-dung-api-gpio">Sử dụng API GPIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ngat-gpio">Ngắt GPIO</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="uart_interrupt.html">Ngắt UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="timer_interrupt.html">Ngắt Timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="command.html">Các API thường gặp</a></li>
<li class="toctree-l3"><a class="reference internal" href="exercise.html">Thực hành</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../8.Thread/index.html">Thread in Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14.LVGL/index.html">LVGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15.Modbus_TCP/index.html">Modbus - TCP/IP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../16.LVGL-SquareLine/index.html">LVGL</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zephyr_tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Giới thiệu về Ngắt - Interrupt</a></li>
      <li class="breadcrumb-item active">Ngắt Ngoại vi GPIO - External Interrupt GPIO</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/7.Interrupt/gpio_interrupt.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="ngat-ngoai-vi-gpio-external-interrupt-gpio">
<h1>Ngắt Ngoại vi GPIO - External Interrupt GPIO<a class="headerlink" href="#ngat-ngoai-vi-gpio-external-interrupt-gpio" title="Link to this heading"></a></h1>
<section id="tom-tat-phan-cung">
<h2>Tóm tắt phần cứng<a class="headerlink" href="#tom-tat-phan-cung" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Board phát triển được sử dụng làm ví dụ là STM32F746G Discovery</p>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>NSX</p></th>
<th class="head"><p>BOARD</p></th>
<th class="head"><p>Kernel</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>ST</p></td>
<td><p>STM32F746G_DISCO</p></td>
<td><p>CORTEX-M7</p></td>
</tr>
</tbody>
</table>
<a class="reference internal image-reference" href="../_images/cortex.png"><img alt="../_images/cortex.png" src="../_images/cortex.png" style="width: 100%;" /></a>
<p>Bộ điều khiển ngắt:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Đối tượng</p></th>
<th class="head"><p>Kernel</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>NVIC (Nested Vectored Interrupt Controller)</p></td>
<td><p>Bộ điều khiển ngắt Vector ngắt lồng nhau</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>NVIC hỗ trợ các ngắt lồng nhau, nghĩa là khi một ngắt được kích hoạt, nó hỗ trợ nhiều cấp độ ngắt. Mỗi ngắt có một mức độ ưu tiên. CPU thực hiện các ngắt khác nhau tùy theo mức độ ưu tiên.</p></li>
<li><p>Nếu một ngắt khác xuất hiện trong khi đang thực hiện ngắt hiện tại, CPU sẽ xác định mức ưu tiên ngắt nào cao hơn mức ưu tiên ngắt hiện đang được thực thi, nếu lớn hơn mức ưu tiên ngắt hiện tại thì nó sẽ  nhảy để thực hiện ngắt mới, nếu không sẽ bị treo. Đợi quá trình thực hiện ngắt này kết thúc quá trình xử lý tiếp theo.</p></li>
<li><p>NVIC được kết nối chặt chẽ với CPU, CPU có thể giao tiếp với NVIC thông qua bus để biết trạng thái của ngắt hiện tại nhằm đảm bảo ngắt nào sẽ được thực thi.</p></li>
<li><p>Thông tin về ngắt luôn được cung cấp trong tài liệu liên quan đến cấu trúc Chip</p></li>
</ul>
<p>Sau khi Biên dịch chương trình, cơ bản chúng ta không cần phải quan tâm đến việc sử dụng trình xử lý ngắt nào, vì API hệ thống đã được hợp nhất để quản lý các trình xử lý ngắt này. Chẳng hạn đối với ngắt thuộc ARM có 2 chế độ:</p>
<blockquote>
<div><ul class="simple">
<li><p>FIQ - IRQ Ngắt nhanh</p></li>
<li><p>IRQ - Ngắt thường</p></li>
</ul>
</div></blockquote>
<p>Và sau đó để kích hoạt, cần sử dụng các Lệnh:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Lệnh</p></th>
<th class="head"><p>Mô tả</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>cpsid i</p></td>
<td><p>Tắt ngắt IRQ</p></td>
</tr>
<tr class="row-odd"><td><p>cpsie i</p></td>
<td><p>Kích hoạt ngắt IRQ</p></td>
</tr>
<tr class="row-even"><td><p>cpsid f</p></td>
<td><p>Tắt ngắt FIQ</p></td>
</tr>
<tr class="row-odd"><td><p>cpsie f</p></td>
<td><p>Kích hoạt ngắt FIQ</p></td>
</tr>
</tbody>
</table>
</section>
<section id="tong-quan-ve-gpio">
<h2>Tổng quan về GPIO<a class="headerlink" href="#tong-quan-ve-gpio" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Zephyr Sử dụng <code class="docutils literal notranslate"><span class="pre">.dts</span></code>, một kiểu Device Tree tương tự như các OS nhân Linux để đóng gói và quản lý các phần cứng cấp thấp. Hầu như các phần cứng cấp thấp đều khó có thể tiếp cận bởi lớp trên. Từ đó, Zephyr cung cấp các API để dễ dàng giao tiếp với các phần cứng cấp thấp này, giúp việc phát triển trở nên đơn giản hơn.</p></li>
<li><p>Nếu chúng ta muốn thực hiện tạo Ngắt GPIO, trước tiên chúng ta cần phải biết tên GPIO, không phải là địa chỉ. Với Flow đơn thuần, chúng ta phải thông qua GPIO để lấy địa chỉ và cấu hình các thanh ghi chức năng trong đó, nhưng với Zephyr, chỉ cần thông qua tên GPIO đã được khai báo trong <code class="docutils literal notranslate"><span class="pre">.dts</span></code> kèm theo các API là chúng ta đã có thể cấu hình được.</p></li>
</ul>
<p><img alt="hw_table" src="../_images/gpio.png" /></p>
<ul>
<li><p>Còn việc tạo Ngắt, khai báo Ngắt, không khác gì so với Flow như bình thường: <code class="docutils literal notranslate"><span class="pre">Cấu</span> <span class="pre">hình</span> <span class="pre">thanh</span> <span class="pre">ghi</span> <span class="pre">GPIO</span> <span class="pre">→</span>&#160; <span class="pre">Kích</span> <span class="pre">hoạt</span> <span class="pre">Ngắt.</span></code></p></li>
<li><p>Quy trình cụ thể là: <code class="docutils literal notranslate"><span class="pre">Cài</span> <span class="pre">đặt</span> <span class="pre">chế</span> <span class="pre">độ</span> <span class="pre">chân</span> <span class="pre">INPUT</span> <span class="pre">→</span> <span class="pre">Cài</span> <span class="pre">đặt</span> <span class="pre">Mode</span> <span class="pre">ngắt</span> <span class="pre">→</span> <span class="pre">Cấu</span> <span class="pre">hình</span> <span class="pre">điều</span> <span class="pre">kiện</span> <span class="pre">kích</span> <span class="pre">hoạt</span> <span class="pre">→</span> <span class="pre">Đăng</span> <span class="pre">ký</span> <span class="pre">LVT</span> <span class="pre">→</span> <span class="pre">Kích</span> <span class="pre">hoạt</span> <span class="pre">ngắt</span></code></p></li>
<li><p>Về trường hợp sử dụng GPIO trong ngắt:</p>
<p>Ví dụ mình muốn phát triển driver cho một cảm biến để phát hiện những thay đổi trong cảm biến, nhưng cảm biến này sẽ chỉ nhận dữ liệu trong một số điều kiện nhất định. Chẳng hạn như Cảm biến hồng ngoại sẽ chỉ xuất dữ liệu khi có phản hồi từ tia hồng ngoại. Nếu không, không có tín hiệu. Vậy chúng ta có phải viết chương trình để theo dõi liên tục xem có dữ liệu đến từ GPIO?</p>
<p>Cách tiếp cận này rất vô lý, vì nó sẽ ngốn tài nguyên của CPU. Tốt hơn hết là để CPU ngủ hoặc làm một số việc khác, và chỉ thức dậy khi cờ tràn và tạo ra một ngắt. Tốt hơn nên giám sát ở trạng thái vòng lặp while. Đây là thiết kế hợp lý nhất để CPU thực hiện công việc.</p>
</li>
</ul>
</section>
<section id="phan-tich-device-tree">
<h2>Phân tích Device Tree<a class="headerlink" href="#phan-tich-device-tree" title="Link to this heading"></a></h2>
<p>Zephyr sẽ gọi một số lệnh để phân tích file Device Tree <code class="docutils literal notranslate"><span class="pre">.dts</span></code> để tạo tệp cấu trúc phần cứng mà chương trình sẽ chạy trên nó. Ví dụ: Board</p>
<p>STM32F746G Discovery, trong Zephyr có định dạng file <code class="docutils literal notranslate"><span class="pre">.dts</span></code>:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~
find<span class="w"> </span>.<span class="w"> </span>-iname<span class="w"> </span><span class="s2">&quot;stm32f746g_disco&quot;</span>
</pre></div>
</div>
<p>Trong file này, chúng ta có thể thấy các tên gọi đại diện cho các ngoại vi:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;st/f7/stm32f746Xg.dtsi&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;st/f7/stm32f746nghx-pinctrl.dtsi&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;arduino_r3_connector.dtsi&quot;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/input/input-event-codes.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/memory-attr/memory-attr.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/memory-attr/memory-attr-arm.h&gt;</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">aliases</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">green_led_1</span><span class="p">;</span>
<span class="w">        </span><span class="n">sw0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">user_button</span><span class="p">;</span>
<span class="w">        </span><span class="n">spi</span><span class="o">-</span><span class="n">flash0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">n25q128a1</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Các file này thường là một tập hợp các file cấu trúc, nếu tìm sâu hơn <code class="docutils literal notranslate"><span class="pre">st/f7/stm32f746Xg.dtsi</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;mem.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;st/f7/stm32f746.dtsi&gt;</span>

<span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">soc</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">flash</span><span class="o">-</span><span class="n">controllerb</span><span class="w"> </span><span class="mi">40023</span><span class="n">c00</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nl">flash0</span><span class="p">:</span><span class="w"> </span><span class="n">flash</span><span class="w"> </span><span class="mi">8000000</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x08000000</span><span class="w"> </span><span class="n">DT_SIZE_K</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                        </span><span class="p">};</span>
<span class="w">                </span><span class="p">};</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Qua đó, chúng ta có thể thấy, các file này thường giống nhau bởi nó có chung một họ Chip</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;st/f7/stm32f7.dtsi&gt;</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Nó chứa tệp <code class="docutils literal notranslate"><span class="pre">stm32f7.dtsi</span></code>, xác định tất cả thông tin phần cứng của họ F7</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;arm/armv7-m.dtsi&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/clock/stm32f7_clock.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/i2c/i2c.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/gpio/gpio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/pwm/pwm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/pwm/stm32_pwm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/dma/stm32_dma.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/adc/stm32f4_adc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/reset/stm32f2_4_7_reset.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/adc/adc.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/memory-controller/stm32-fmc-sdram.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/memory-attr/memory-attr.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/dt-bindings/memory-attr/memory-attr-arm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;freq.h&gt;</span>
<span class="p">...</span>
<span class="w">        </span><span class="nl">exti</span><span class="p">:</span><span class="w"> </span><span class="n">interrupt</span><span class="o">-</span><span class="n">controller</span><span class="w"> </span><span class="mi">40013</span><span class="n">c00</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-exti&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">interrupt</span><span class="o">-</span><span class="n">controller</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#interrupt-cells = &lt;1&gt;;</span>
<span class="w">            </span><span class="cp">#address-cells = &lt;1&gt;;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40013c00</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">num</span><span class="o">-</span><span class="n">lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">interrupts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">6</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">7</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">8</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">9</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                     </span><span class="o">&lt;</span><span class="mi">10</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">23</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">40</span><span class="w"> </span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="n">interrupt</span><span class="o">-</span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;line0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;line1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;line2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;line3&quot;</span><span class="p">,</span>
<span class="w">                      </span><span class="s">&quot;line4&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;line5-9&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;line10-15&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="n">line</span><span class="o">-</span><span class="n">ranges</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">2</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">3</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">                      </span><span class="o">&lt;</span><span class="mi">4</span><span class="w"> </span><span class="mi">1</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">5</span><span class="w"> </span><span class="mi">5</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mi">10</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="w">        </span><span class="nl">pinctrl</span><span class="p">:</span><span class="w"> </span><span class="n">pin</span><span class="o">-</span><span class="n">controller</span><span class="w"> </span><span class="mi">40020000</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-pinctrl&quot;</span><span class="p">;</span>
<span class="w">            </span><span class="cp">#address-cells = &lt;1&gt;;</span>
<span class="w">            </span><span class="cp">#size-cells = &lt;1&gt;;</span>
<span class="w">            </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40020000</span><span class="w"> </span><span class="mh">0x2400</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">            </span><span class="nl">gpioa</span><span class="p">:</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="mi">40020000</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-gpio&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">gpio</span><span class="o">-</span><span class="n">controller</span><span class="p">;</span>
<span class="w">                </span><span class="cp">#gpio-cells = &lt;2&gt;;</span>
<span class="w">                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40020000</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">rcc</span><span class="w"> </span><span class="n">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x00000001</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="nl">gpiob</span><span class="p">:</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="mi">40020400</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-gpio&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">gpio</span><span class="o">-</span><span class="n">controller</span><span class="p">;</span>
<span class="w">                </span><span class="cp">#gpio-cells = &lt;2&gt;;</span>
<span class="w">                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40020400</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">rcc</span><span class="w"> </span><span class="n">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x00000002</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="nl">gpioc</span><span class="p">:</span><span class="w"> </span><span class="n">gpio</span><span class="w"> </span><span class="mi">40020800</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;st,stm32-gpio&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">gpio</span><span class="o">-</span><span class="n">controller</span><span class="p">;</span>
<span class="w">                </span><span class="cp">#gpio-cells = &lt;2&gt;;</span>
<span class="w">                </span><span class="n">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="mh">0x40020800</span><span class="w"> </span><span class="mh">0x400</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">clocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">rcc</span><span class="w"> </span><span class="n">STM32_CLOCK_BUS_AHB1</span><span class="w"> </span><span class="mh">0x00000004</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">            </span><span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
<p>Chúng ta có thể có được tất cả các khai báo phần cứng của họ F7 này, và vì vậy nên:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">gpio_keys</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gpio-keys&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="nl">user_button</span><span class="p">:</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;User&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="n">gpios</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;&amp;</span><span class="n">gpioi</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="n">GPIO_ACTIVE_HIGH</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">                </span><span class="n">zephyr</span><span class="p">,</span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&lt;</span><span class="n">INPUT_KEY_0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">        </span><span class="p">};</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Phần khai báo <code class="docutils literal notranslate"><span class="pre">.dts</span></code> này định nghĩa một cổng GPIOs trỏ đến thuộc tính <code class="docutils literal notranslate"><span class="pre">gpioi</span></code>, Active mức cao. Điều này cho biết, muốn kích hoạt nó phải cho ra tín hiệu mức cao.</p>
</section>
<section id="cac-cau-truc-du-lieu-lien-quan-den-devicetree">
<h2>Các cấu trúc dữ liệu liên quan đến DeviceTree<a class="headerlink" href="#cac-cau-truc-du-lieu-lien-quan-den-devicetree" title="Link to this heading"></a></h2>
<p>Cấu trúc dữ liệu thường được sử dụng nhất là <code class="docutils literal notranslate"><span class="pre">gpio_dt_spec</span></code>, là một cấu trúc đặc biệt khởi tạo thông tin được khai báo trong <code class="docutils literal notranslate"><span class="pre">.dts</span></code>. Cấu trúc này được khởi tạo ở <code class="docutils literal notranslate"><span class="pre">zephyr/include/drivers</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">;</span>
<span class="w">    </span><span class="n">gpio_pin_t</span><span class="w"> </span><span class="n">pin</span><span class="p">;</span>
<span class="w">    </span><span class="n">gpio_dt_flags_t</span><span class="w"> </span><span class="n">dt_flags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tên biến</p></th>
<th class="head"><p>Kiểu</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>port</p></td>
<td><p>device*</p></td>
<td><p>Trỏ tới bộ điều khiển Device sau khi
khởi tạo <code class="docutils literal notranslate"><span class="pre">dtc</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>pin</p></td>
<td><p>gpio_pin_t</p></td>
<td><p>Trỏ tới Pin định danh của Device</p></td>
</tr>
<tr class="row-even"><td><p>dt_flags</p></td>
<td><p>gpio_dt_flags_t</p></td>
<td><p>Thuộc tính Device</p></td>
</tr>
</tbody>
</table>
<p>Cấu trúc <code class="docutils literal notranslate"><span class="pre">device*</span></code> của <code class="docutils literal notranslate"><span class="pre">*port</span></code> mang các thuộc tính sau:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">device_state</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">device_handle_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">handles</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM_DEVICE</span>
<span class="w">    </span><span class="n">pm_device_control_callback_t</span><span class="w"> </span><span class="n">pm_control</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pm_device</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">pm</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>
</pre></div>
</div>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tên biến</p></th>
<th class="head"><p>Kiểu</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>api</p></td>
<td><p>const void *</p></td>
<td><p>Địa chỉ tới cấu trúc API</p></td>
</tr>
<tr class="row-odd"><td><p>config</p></td>
<td><p>const void *</p></td>
<td><p>Địa chỉ tới thông tin cấu
hình</p></td>
</tr>
<tr class="row-even"><td><p>data</p></td>
<td><p>void * const</p></td>
<td><p>Địa chỉ dữ liệu riêng
Device</p></td>
</tr>
<tr class="row-odd"><td><p>handles</p></td>
<td><p>device_handle_t*</p></td>
<td><p>Con trỏ tới hàm liên kết
Device</p></td>
</tr>
<tr class="row-even"><td><p>name</p></td>
<td><p>const char *</p></td>
<td><p>Tên Device được cấu hình
trong <code class="docutils literal notranslate"><span class="pre">dts</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>pm</p></td>
<td><p>pm_device *</p></td>
<td><p>Con trỏ tới dữ liệu PM
Device</p></td>
</tr>
<tr class="row-even"><td><p>pm_control</p></td>
<td><p>pm_device_control_callback_t</p></td>
<td><p>Chức năng Power
Management</p></td>
</tr>
<tr class="row-odd"><td><p>state</p></td>
<td><p>device_state *</p></td>
<td><p>Địa chỉ thanh ghi trạng
thái Device</p></td>
</tr>
</tbody>
</table>
<p>Nói chung, khi cần sử dụng Bus hoặc các Ngoại vi được đề cập trong
<code class="docutils literal notranslate"><span class="pre">.dts</span></code> thì chúng ta cần sử dụng <code class="docutils literal notranslate"><span class="pre">gpio_dt_spec</span></code></p>
</section>
<section id="khoi-tao-thiet-bi">
<h2>Khởi tạo thiết bị<a class="headerlink" href="#khoi-tao-thiet-bi" title="Link to this heading"></a></h2>
<p>Zephyr cung cấp các Hàm Macro để khởi tạo Device - Clone từ Device Tree.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">DT_ALIAS</span>
<span class="n">DT_GPIO_LABEL</span>
<span class="n">DT_GPIO_PIN</span>
<span class="n">DT_GPIO_FLAGS</span>
<span class="n">GPIO_DT_SPEC_GET_OR</span>
</pre></div>
</div>
<p>Được khai báo tại: <code class="docutils literal notranslate"><span class="pre">zephyr/include/drivers/gpio.h</span></code> Các hàm Macro này sẽ thu các tham số khởi tạo Device <strong>trong quá trình biên dịch</strong>. Trước khi thực sự biên dịch, Zephyr sẽ gọi 1 tập lệch đặc biệt, thông qua các Macro này để phân tích các tệp DeviceTree và tạo tệp <code class="docutils literal notranslate"><span class="pre">.h</span></code> tương ứng với các sửa đổi.</p>
<section id="dt-alias">
<h3>1. <code class="docutils literal notranslate"><span class="pre">DT_ALIAS</span></code><a class="headerlink" href="#dt-alias" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DT_ALIAS(alias)</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">alias</span></code></p></td>
<td><p>Lấy cấu trúc thông tin Device
thông qua Alias</p></td>
</tr>
</tbody>
</table>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*dtc</span>
<span class="cm"> leds {</span>
<span class="cm">        compatible &amp;#61; &amp;#34;gpio-leds&amp;#34;;</span>
<span class="cm">        green_led_1: led_1 {</span>
<span class="cm">            gpios &amp;#61; &amp;lt;&amp;amp;gpioi 1 GPIO_ACTIVE_HIGH&amp;gt;;</span>
<span class="cm">            label &amp;#61; &amp;#34;User LD1&amp;#34;;</span>
<span class="cm">        };</span>
<span class="cm">    };</span>

<span class="cm">    aliases {</span>
<span class="cm">        led0 &amp;#61; &amp;amp;green_led_1;</span>
<span class="cm">    };</span>
<span class="cm">*/</span>
<span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led0</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="dt-gpio-label">
<h3>2. <code class="docutils literal notranslate"><span class="pre">DT_GPIO_LABEL</span></code><a class="headerlink" href="#dt-gpio-label" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DT_GPIO_LABEL</span>
<span class="pre">(node_id,</span> <span class="pre">gpio_pha)</span></code></p></td>
<td><p>Node ID, Đối tượng
GPIO</p></td>
<td><p>Lấy tên/nhãn GPIO</p></td>
</tr>
</tbody>
</table>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*dtc</span>
<span class="cm"> leds {</span>
<span class="cm">        compatible &amp;#61; &amp;#34;gpio-leds&amp;#34;;</span>
<span class="cm">        green_led_1: led_1 {</span>
<span class="cm">            gpios &amp;#61; &amp;lt;&amp;amp;gpioi 1 GPIO_ACTIVE_HIGH&amp;gt;;</span>
<span class="cm">            label &amp;#61; &amp;#34;User LD1&amp;#34;;</span>
<span class="cm">        };</span>
<span class="cm">    };</span>

<span class="cm">    aliases {</span>
<span class="cm">        led0 &amp;#61; &amp;amp;green_led_1;</span>
<span class="cm">    };</span>
<span class="cm">*/</span>
<span class="n">DT_GPIO_LABEL</span><span class="p">(</span><span class="n">green_led_1</span><span class="p">,</span><span class="n">gpios</span><span class="p">)</span><span class="w"> </span><span class="c1">//gpioi</span>
</pre></div>
</div>
</section>
<section id="dt-gpio-pin">
<h3>3. <code class="docutils literal notranslate"><span class="pre">DT_GPIO_PIN</span></code><a class="headerlink" href="#dt-gpio-pin" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DT_GPIO_PIN(node_id,</span> <span class="pre">gpio_pha)</span></code></p></td>
<td><p>Node ID, Đối tượng GPIO</p></td>
<td><p>Lấy chỉ số GPIO</p></td>
</tr>
</tbody>
</table>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*dtc</span>
<span class="cm"> leds {</span>
<span class="cm">        compatible &amp;#61; &amp;#34;gpio-leds&amp;#34;;</span>
<span class="cm">        green_led_1: led_1 {</span>
<span class="cm">            gpios &amp;#61; &amp;lt;&amp;amp;gpioi 1 GPIO_ACTIVE_HIGH&amp;gt;;</span>
<span class="cm">            label &amp;#61; &amp;#34;User LD1&amp;#34;;</span>
<span class="cm">        };</span>
<span class="cm">    };</span>

<span class="cm">    aliases {</span>
<span class="cm">        led0 &amp;#61; &amp;amp;green_led_1;</span>
<span class="cm">    };</span>
<span class="cm">*/</span>
<span class="n">DT_GPIO_PIN</span><span class="p">(</span><span class="n">green_led_1</span><span class="p">,</span><span class="n">gpios</span><span class="p">)</span><span class="w"> </span><span class="c1">//gpioi</span>
</pre></div>
</div>
</section>
<section id="dt-gpio-flags">
<h3>4. <code class="docutils literal notranslate"><span class="pre">DT_GPIO_FLAGS</span></code><a class="headerlink" href="#dt-gpio-flags" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DT_GPIO_FLAGS(node_id,</span> <span class="pre">gpio_pha)</span></code></p></td>
<td><p>Node ID, Đối tượng GPIO</p></td>
<td><p>Lấy thuộc tính GPIO</p></td>
</tr>
</tbody>
</table>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*dtc</span>
<span class="cm">*/</span>
<span class="n">DT_GPIO_FLAGS</span><span class="p">(</span><span class="n">green_led_1</span><span class="p">,</span><span class="n">gpios</span><span class="p">)</span><span class="w"> </span><span class="c1">//gpioi</span>
</pre></div>
</div>
</section>
<section id="gpio-dt-spec-get-or">
<h3>5. <code class="docutils literal notranslate"><span class="pre">GPIO_DT_SPEC_GET_OR</span></code><a class="headerlink" href="#gpio-dt-spec-get-or" title="Link to this heading"></a></h3>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GPIO_DT_SPEC_GET_OR(node_id,</span> <span class="pre">prop,</span> <span class="pre">defaut_value)</span></code></p></td>
<td><p>Node ID, Đối tượng GPIO, chỉ số</p></td>
<td><p>Lấy thuộc tính GPIO và khởi tạo chúng dưới dạng <code class="docutils literal notranslate"><span class="pre">gpio_dt_spec</span></code></p></td>
</tr>
</tbody>
</table>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*dtc</span>
<span class="cm">*/</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">gpio_led</span><span class="w"> </span><span class="mi">61</span><span class="p">;</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET_OR</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led0</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">,{</span><span class="mi">0</span><span class="p">})</span>
</pre></div>
</div>
</section>
</section>
<section id="su-dung-api-gpio">
<h2>Sử dụng API GPIO<a class="headerlink" href="#su-dung-api-gpio" title="Link to this heading"></a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">gpio_pin_configure_dt</span>
<span class="n">gpio_pin_interrupt_configure_dt</span>
<span class="n">gpio_init_callback</span>
<span class="n">gpio_add_callback</span>
<span class="n">gpio_pin_configure</span>
<span class="n">gpio_pin_set</span>
</pre></div>
</div>
<p>Giá trị trả về: 0 nếu thành công, khác 0 nếu thất bại.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Nguyên hàm</p></th>
<th class="head"><p>Đối số</p></th>
<th class="head"><p>Tác dụng</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_pin_configure_dt(struct</span> <span class="pre">gpio_dt_spec</span> <span class="pre">*st,</span> <span class="pre">int</span> <span class="pre">FLAGS)</span></code></p></td>
<td><p>Cấu trúc <cite>dtc</cite> Device, Thuộc tính cài đặt</p></td>
<td><p>Đặt thuộc tính GPIO</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_pin_interrupt_configure_dt(struct</span> <span class="pre">gpio_dt_spec</span> <span class="pre">*st,</span> <span class="pre">int</span> <span class="pre">FLAGS)</span></code></p></td>
<td><p>Cấu trúc dtc Device, Thuộc tính cài đặt</p></td>
<td><p><strong>Đặt ngắt GPIO</strong></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_init_callback(struct</span> <span class="pre">gpio_dt_spec</span> <span class="pre">*</span> <span class="pre">st,</span> <span class="pre">void</span> <span class="pre">(*func)(const</span> <span class="pre">struct</span> <span class="pre">device*,</span> <span class="pre">struct</span> <span class="pre">gpio_callback*,</span> <span class="pre">unit32_t),</span> <span class="pre">_addr,</span> <span class="pre">bit_pin)</span></code></p></td>
<td><p>Cấu trúc khởi tạo Device, Hàm dịch vụ ngắt, Chân Pin chuyển đổi Macro bit</p></td>
<td><p><strong>Đặt chức năng ngắt GPIO</strong></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_add_callback(struct</span> <span class="pre">device</span> <span class="pre">*port,</span> <span class="pre">struct</span> <span class="pre">gpio_callback</span> <span class="pre">*st)</span></code></p></td>
<td><p>Cấu trúc Device, Cấu trúc lưu thuộc tính cài đặt</p></td>
<td><p><strong>Thêm dịch vụ ngắt</strong></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_pin_configure(struct</span> <span class="pre">device</span> <span class="pre">*</span> <span class="pre">port,</span> <span class="pre">pin</span> <span class="pre">,</span> <span class="pre">int</span> <span class="pre">FLAGS)</span></code></p></td>
<td><p>Cấu trúc Device, Pin, Thuộc tính</p></td>
<td><p>Đặt thuộc tính cho GPIO</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gpio_pin_set(struct</span> <span class="pre">device</span> <span class="pre">*port,</span> <span class="pre">pin,</span> <span class="pre">value</span> <span class="pre">int)</span></code></p></td>
<td><p>Cấu trúc thiết bị, chân Pin, giá trị</p></td>
<td><p>Đặt giá trị GPIO</p></td>
</tr>
</tbody>
</table>
<p>Các thuộc tính có thể lựa chọn tham số</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Tham số</p></th>
<th class="head"><p>Mang thuộc tính</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>GPIO_INPUT</p></td>
<td><p>Chế độ Input</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_OUTPUT</p></td>
<td><p>Chế độ Output</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_DISCONNECTED</p></td>
<td><p>Tắt chế độ đầu vào và đầu ra</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_OUTPUT_INIT_LOW</p></td>
<td><p>Đặt trạng thái ban đầu đầu ra ở mức thấp</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_OUTPUT_INIT_HIGH</p></td>
<td><p>Đặt trạng thái ban đầu đầu ra ở mức cao</p></td>
</tr>
<tr class="row-odd"><td><p>GPI
O_OUTPUT_INIT_LOGICAL</p></td>
<td><p>Khởi tạo đầu ra theo mức logic</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_OUTPUT_LOW</p></td>
<td><p>Định cấu hình chân GPIO làm đầu ra và khởi
tạo nó ở mức thấp</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_OUTPUT_HIGH</p></td>
<td><p>Định cấu hình chân GPIO làm đầu ra và khởi
tạo nó ở mức cao.</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_OUTPUT_INACTIVE</p></td>
<td><p>Định cấu hình chân GPIO làm đầu ra và khởi
tạo nó thành logic 0.</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_OUTPUT_ACTIVE</p></td>
<td><p>Định cấu hình chân GPIO làm đầu ra và khởi
tạo nó thành logic 1.</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_DISABLE</p></td>
<td><p>Vô hiệu hóa ngắt pin GPIO</p></td>
</tr>
<tr class="row-odd"><td><p>GP
IO_INT_LEVELS_LOGICAL</p></td>
<td><p>Mức Logic ngắt</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_EDGE</p></td>
<td><p>Ngắt cạnh</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_INT_LOW_0</p></td>
<td><p>Ngắt kích hoạt bởi mức thấp hoặc mức logic 0</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_HIGH_1</p></td>
<td><p>Ngắt kích hoạt bởi mức cao hoặc mức logic 1</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_INT_EDGE_RISING</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở cạnh
tăng của chân</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_EDGE_FALLING</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở cạnh
tăng hoặc giảm của chân</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_INT_EDGE_FALLING</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở cạnh
rơi của chân</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_EDGE_BOTH</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở cạnh
tăng hoặc giảm của chân</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_INT_LEVEL_LOW</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt khi
chân ở mức thấp</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_LEVEL_HIGH</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt khi mức
cao</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO
_INT_EDGE_TO_INACTIVE</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt khi
trạng thái chân thay đổi thành mức logic 0</p></td>
</tr>
<tr class="row-even"><td><p>GP
IO_INT_EDGE_TO_ACTIVE</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt khi
trạng thái chân thay đổi thành mức logic 1</p></td>
</tr>
<tr class="row-odd"><td><p>GP
IO_INT_LEVEL_INACTIVE</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở mức
logic chân 0 v</p></td>
</tr>
<tr class="row-even"><td><p>GPIO_INT_LEVEL_ACTIVE</p></td>
<td><p>Định cấu hình ngắt GPIO để kích hoạt ở mức
logic chân 1</p></td>
</tr>
<tr class="row-odd"><td><p>GPIO_INT_DEBOUNCE</p></td>
<td><p>Kích hoạt tính năng chống rung pin GPIO</p></td>
</tr>
</tbody>
</table>
</section>
<section id="ngat-gpio">
<h2>Ngắt GPIO<a class="headerlink" href="#ngat-gpio" title="Link to this heading"></a></h2>
<p><strong>1. Tạo chức năng dịch vụ ngắt</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">irq_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="o">*</span><span class="w"> </span><span class="n">cb</span><span class="p">,</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pins</span><span class="p">){</span>
<span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;okay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Từ các đối số đã nhắc tới ở trên,
<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">(*func)(const</span> <span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*,struct</span> <span class="pre">gpio_callback*</span> <span class="pre">,uint32_t)</span></code></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="o">*</span><span class="n">dev</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Trỏ</span><span class="w"> </span><span class="n">tới</span><span class="w"> </span><span class="n">Device</span>
<span class="w"> </span><span class="nl">cb</span><span class="w">  </span><span class="p">:</span><span class="w"> </span><span class="n">Thuộc</span><span class="w"> </span><span class="n">tính</span><span class="w"> </span><span class="n">dịch</span><span class="w"> </span><span class="n">vụ</span><span class="w"> </span><span class="n">ngắt</span>
<span class="w"> </span><span class="nl">pin</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">Chỉ</span><span class="w"> </span><span class="n">số</span><span class="w"> </span><span class="n">chân</span><span class="w"> </span><span class="n">ngắt</span><span class="w"> </span><span class="n">hiện</span><span class="w"> </span><span class="n">tại</span>
</pre></div>
</div>
<p><strong>2. Cấu hình ngắt</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
<span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="p">);</span>
<span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gpio_data</span><span class="p">,</span><span class="w"> </span><span class="n">my_isr</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span>
<span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">gpio_data</span><span class="p">);</span>
<span class="n">gpio_pin_configure</span><span class="p">(</span><span class="n">gpio</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">PIN</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="admonition-title">Gợi ý</p>
<p>Từng bước như sau:</p>
<ul class="simple">
<li><p>Cấu hình ngắt để là chế độ input</p></li>
<li><p>Cấu hình GPIO ngắt để kích hoạt khi trạng thái chân thay đổi thành mức logic 1 và kích hoạt nó</p></li>
<li><p>Gán hàm ngắt với chân pin và lưu cấu trúc khởi tạo vào gpio_data</p></li>
<li><p>Thêm cấu trúc vừa gán vào bảng vector</p></li>
<li><p>Cấu hình chế độ của chân pin</p></li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Giới thiệu về Ngắt - Interrupt" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="uart_interrupt.html" class="btn btn-neutral float-right" title="Ngắt UART" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Bao Bui.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
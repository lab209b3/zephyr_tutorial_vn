<!DOCTYPE html>
<html class="writer-html5" lang="vi" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Giới thiệu về Ngắt - Interrupt &mdash; Tài liệu zephyr_tutorial </title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=d3888072"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=f281be69"></script>
        <script src="../_static/translations.js?v=71464233"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="../search.html" />
    <link rel="next" title="Ngắt Ngoại vi GPIO - External Interrupt GPIO" href="gpio_interrupt.html" />
    <link rel="prev" title="Exercise 1" href="../6.I2C/exercise/ex1/readme.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            zephyr_tutorial
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../1.zephyr-setup/index.html">Cài đặt Zephyr cho máy tính</a></li>
<li class="toctree-l1"><a class="reference internal" href="../2.introduction/index.html">Giới thiệu</a></li>
<li class="toctree-l1"><a class="reference internal" href="../3.GPIO/index.html">GPIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="../4.Timers/index.html">Lesson 4: Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../5.UART/index.html">UART</a></li>
<li class="toctree-l1"><a class="reference internal" href="../6.I2C/index.html">I2C</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Giới thiệu về Ngắt - Interrupt</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tong-quat">Tổng quát</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ngat-trong-zephyr-interrupt-api-zephyr">Ngắt trong Zephyr - Interrupt API Zephyr</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cac-loai-ngat-trong-zephyr">Các loại Ngắt trong Zephyr</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#isr-thong-thuong">ISR Thông Thường</a></li>
<li class="toctree-l3"><a class="reference internal" href="#isr-truc-tiep">ISR Trực tiếp:</a></li>
<li class="toctree-l3"><a class="reference internal" href="#isr-do-tre-bang-0-zero-latency">ISR độ trễ bằng 0 - Zero Latency</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bang-vector-ngat-cua-zephyr">Bảng Vector Ngắt của Zephyr</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ngat-thong-thuong-regular-interrupt">Ngắt Thông thường - Regular Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ngat-truc-tiep-direct-interrupt">Ngắt Trực tiếp - Direct Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ngat-co-do-tre-bang-0-zero-latency-interrupt">Ngắt có độ trễ bằng 0 - Zero Latency Interrupt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ung-dung-ngat-ngoai-vi-gpio">Ứng dụng - Ngắt Ngoại vi - GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ung-dung-ngat-timer">Ứng dụng - Ngắt Timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ung-dung-ngat-uart">Ứng dụng - Ngắt UART</a></li>
<li class="toctree-l2"><a class="reference internal" href="#vo-hieu-hoa-mot-ngat">Vô hiệu hóa một Ngắt</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cac-api-thuong-gap">Các API thường gặp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thuc-hanh">Thực hành</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lien-ket">Liên kết</a><ul>
<li class="toctree-l3"><a class="reference internal" href="gpio_interrupt.html">Ngắt Ngoại vi GPIO - External Interrupt GPIO</a></li>
<li class="toctree-l3"><a class="reference internal" href="uart_interrupt.html">Ngắt UART</a></li>
<li class="toctree-l3"><a class="reference internal" href="timer_interrupt.html">Ngắt Timer</a></li>
<li class="toctree-l3"><a class="reference internal" href="command.html">Các API thường gặp</a></li>
<li class="toctree-l3"><a class="reference internal" href="exercise.html">Thực hành</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../8.Thread/index.html">Thread in Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../14.LVGL/index.html">LVGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../15.Modbus_TCP/index.html">Modbus - TCP/IP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../16.LVGL-SquareLine/index.html">LVGL</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zephyr_tutorial</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Giới thiệu về Ngắt - Interrupt</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/7.Interrupt/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="gioi-thieu-ve-ngat-interrupt">
<h1>Giới thiệu về Ngắt - Interrupt<a class="headerlink" href="#gioi-thieu-ve-ngat-interrupt" title="Link to this heading"></a></h1>
<p><strong>Ngắt</strong> (interrupt) - IRQ (Interrupt Request) là quá trình dừng chương trình chính đang chạy để ưu tiên thực hiện một chương trình khác, chương trình này được gọi là <strong>chương trình phục vụ ngắt</strong> (ISR – Interrupt Service Routine).</p>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#tong-quat" id="id3">Tổng quát</a></p></li>
<li><p><a class="reference internal" href="#ngat-trong-zephyr-interrupt-api-zephyr" id="id4">Ngắt trong Zephyr - Interrupt API Zephyr</a></p></li>
<li><p><a class="reference internal" href="#cac-loai-ngat-trong-zephyr" id="id5">Các loại Ngắt trong Zephyr</a></p>
<ul>
<li><p><a class="reference internal" href="#isr-thong-thuong" id="id6">ISR Thông Thường</a></p></li>
<li><p><a class="reference internal" href="#isr-truc-tiep" id="id7">ISR Trực tiếp:</a></p></li>
<li><p><a class="reference internal" href="#isr-do-tre-bang-0-zero-latency" id="id8">ISR độ trễ bằng 0 - Zero Latency</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#bang-vector-ngat-cua-zephyr" id="id9">Bảng Vector Ngắt của Zephyr</a></p></li>
<li><p><a class="reference internal" href="#ngat-thong-thuong-regular-interrupt" id="id10">Ngắt Thông thường - Regular Interrupt</a></p></li>
<li><p><a class="reference internal" href="#ngat-truc-tiep-direct-interrupt" id="id11">Ngắt Trực tiếp - Direct Interrupt</a></p></li>
<li><p><a class="reference internal" href="#ngat-co-do-tre-bang-0-zero-latency-interrupt" id="id12">Ngắt có độ trễ bằng 0 - Zero Latency Interrupt</a></p></li>
<li><p><a class="reference internal" href="#ung-dung-ngat-ngoai-vi-gpio" id="id13">Ứng dụng - Ngắt Ngoại vi - GPIO</a></p></li>
<li><p><a class="reference internal" href="#ung-dung-ngat-timer" id="id14">Ứng dụng - Ngắt Timer</a></p></li>
<li><p><a class="reference internal" href="#ung-dung-ngat-uart" id="id15">Ứng dụng - Ngắt UART</a></p></li>
<li><p><a class="reference internal" href="#vo-hieu-hoa-mot-ngat" id="id16">Vô hiệu hóa một Ngắt</a></p></li>
<li><p><a class="reference internal" href="#cac-api-thuong-gap" id="id17">Các API thường gặp</a></p></li>
<li><p><a class="reference internal" href="#thuc-hanh" id="id18">Thực hành</a></p></li>
<li><p><a class="reference internal" href="#lien-ket" id="id19">Liên kết</a></p></li>
</ul>
</nav>
<section id="tong-quat">
<h2><a class="toc-backref" href="#id3" role="doc-backlink">Tổng quát</a><a class="headerlink" href="#tong-quat" title="Link to this heading"></a></h2>
<dl class="simple">
<dt>Trong các quá trình ngắt, ta phân biệt thành 2 loại: <strong>ngắt cứng</strong> và <strong>ngắt mềm</strong></dt><dd><ul class="simple">
<li><p><strong>Ngắt mềm</strong> là ngắt được gọi bằng một lệnh trong chương trình ngôn ngữ máy.</p></li>
<li><p>Khác với ngắt mềm, <strong>ngắt cứng</strong> không được khởi động bên trong máy tính mà do các linh kiện điện tử tác đông lên hệ thống.</p></li>
</ul>
</dd>
</dl>
<p><strong>Hoạt động:</strong> Khi thực hiện lệnh gọi ngắt, CPU sẽ tìm kiếm trong bảng vector ngắt địa chỉ của chương trình phục vụ ngắt. Người sử dụng cũng có thể xây dựng môt chương trình cơ sở như các chương trình xử lý ngắt. Sau đó, các chương trình khác có thể gọi ngắt ra để sử dụng. Một chương trình có thể gọi chương trình con loại này mà không cần biết địa chỉ của nó.</p>
</section>
<section id="ngat-trong-zephyr-interrupt-api-zephyr">
<h2><a class="toc-backref" href="#id4" role="doc-backlink">Ngắt trong Zephyr - Interrupt API Zephyr</a><a class="headerlink" href="#ngat-trong-zephyr-interrupt-api-zephyr" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p><strong>Kernel của Zephyr cung cấp một chương trình dịch vụ ngắt mặc định cho tất cả các ngắt chưa được sử dụng.</strong>  Nghĩa là người dùng <strong>có thể không cần phải định nghĩa ngắt cho một số trường hợp cụ thể,</strong> nhưng nếu một sự kiện ngắt xảy ra mà không có dịch vụ ngắt tương ứng được định nghĩa, hệ thống sẽ phát sinh lỗi. Điều này nhấn mạnh tính chắc chắn và sự ổn định trong việc xử lý ngắt, đảm bảo rằng hệ thống không bỏ qua bất kỳ sự kiện ngắt nào mà không được xử lý.</p></li>
<li><dl class="simple">
<dt><strong>Các ngắt có thể lồng ghép nhau với điều kiện đáp ứng với Kernel:</strong></dt><dd><ul>
<li><p>Có Stack riêng cho các ngắt</p></li>
<li><p>Dung lượng Stack đủ lớn để lồng nhau</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><strong>Thực thi Thread chỉ tiếp tục sau khi hoàn thành ISR</strong></p></li>
<li><dl class="simple">
<dt><strong>Ngắt mềm:</strong></dt><dd><ul>
<li><p>Các ngắt thông thường được quản lý bằng ngắt mềm</p></li>
<li><p>Dùng bảng vector ngắt mềm - Một điểm khá mới so với các RTOS khác</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p><strong>Hàm dịch vụ ngắt</strong>
- Ngắt là một kiểu thực thi không đồng bộ
- Ưu tiên quay về Thread hiện tại
- Thời gian thực hiện hàm ngắt không quá lớn để đảm bảo hệ thống có thể dự đoán, ít lỗi, ít bị trễ
- Nên giảm tải quá trình xử lý đến ngắt trong 1 Thread
- Sau khi ISR hoàn thành, hệ thống chuyển sang “Helper thread” <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a> dựa trên độ ưu tiên của Thread. Helper thread này có thể được kích hoạt bằng cách sử dụng một loại kernel object như FIFO, LIFO hoặc semaphore để xử lý các công việc liên quan đến ngắt.*</p>
</div>
<div class="admonition hint">
<p class="admonition-title">Gợi ý</p>
<p>Trong Zephyr, hầu hết các API của Kernel chỉ có thể được sử dụng trong Thread, không thể sử dụng trong ISR (Interrupt Servic Routine). Tuy nhiên, những API Kernel có thể được sử dụng trong ISR thường có thuộc tính là <strong>``isr_ok``</strong>. Điều này giúp người phát triển nhận biết được những API nào có thể an toàn để sử dụng trong ngữ cảnh của ISR, đồng thời giảm thiểu nguy cơ lỗi và tăng tính ổn định của hệ thống. Trong trường hợp một thường trình có thể được gọi bởi cả Thread và ISR, kernel cung cấp hàm <strong>``k_is_in_isr()``</strong> để cho phép thường trình thay đổi hành vi của nó tùy thuộc vào việc nó đang thực thi như một phần của Thread hay là một phần của ISR.</p>
</div>
<a class="reference internal image-reference" href="../_images/k_is_ok.png"><img alt="Một số API Kernel cho phép ngắt đến Thread" src="../_images/k_is_ok.png" style="width: 100%;" /></a>
</section>
<section id="cac-loai-ngat-trong-zephyr">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Các loại Ngắt trong Zephyr</a><a class="headerlink" href="#cac-loai-ngat-trong-zephyr" title="Link to this heading"></a></h2>
<section id="isr-thong-thuong">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">ISR Thông Thường</a><a class="headerlink" href="#isr-thong-thuong" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Được gọi bằng thủ tục dịch vụ ngắt mềm và không thể chạy trực tiếp.</p></li>
<li><p>Đơn giản và dễ sử dụng.</p></li>
</ul>
</section>
<section id="isr-truc-tiep">
<h3><a class="toc-backref" href="#id7" role="doc-backlink">ISR Trực tiếp:</a><a class="headerlink" href="#isr-truc-tiep" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Không sử dụng quy trình dịch vụ ngắt mềm.</p></li>
<li><p>Đăng ký trực tiếp vào <strong>bảng Vector ngắt</strong> phần cứng.</p></li>
<li><p>Độ trễ thấp nhưng có nhiều hạn chế, ví dụ như không thể truyền tham số.</p></li>
</ul>
</section>
<section id="isr-do-tre-bang-0-zero-latency">
<h3><a class="toc-backref" href="#id8" role="doc-backlink">ISR độ trễ bằng 0 - Zero Latency</a><a class="headerlink" href="#isr-do-tre-bang-0-zero-latency" title="Link to this heading"></a></h3>
<ul class="simple">
<li><p>Nó có độ trễ thấp nhất</p></li>
<li><p>Có mức ưu tiên ngắt cao nhất và không bị ảnh hưởng bởi khóa ngắt</p></li>
<li><p>Nó có thể khai báo từ ISR Thông thường hoặc ISR Trực tiếp</p></li>
</ul>
</section>
</section>
<section id="bang-vector-ngat-cua-zephyr">
<h2><a class="toc-backref" href="#id9" role="doc-backlink">Bảng Vector Ngắt của Zephyr</a><a class="headerlink" href="#bang-vector-ngat-cua-zephyr" title="Link to this heading"></a></h2>
<p>Sau các loại Ngắt, kế đến là một khái niệm khá mới được Zephyr thêm vào, đó chính là <strong>Vector Ngắt</strong>.</p>
<p><strong>Bảng Vector Ngắt phần cứng:</strong></p>
<ul class="simple">
<li><p>16 vị trí đầu tiên được cố định dành cho các dịch vụ của Kernel.</p></li>
<li><p>Nếu các vị trí khác chưa được đăng ký thì chương trình dịch vụ ngắt chung <code class="docutils literal notranslate"><span class="pre">_isr_wrapper()</span></code> sẽ được điền vào.</p></li>
</ul>
<p><strong>Bảng Vector Ngắt phần mềm:</strong></p>
<ul class="simple">
<li><p>Chứa các hàm xử lý ngắt phần mềm đã được đăng ký cùng với các tham số liên quan.</p></li>
<li><p>Tất cả các vị trí trong bảng này đều có thể được đăng ký bởi các dịch vụ ngắt <code class="docutils literal notranslate"><span class="pre">z_irq_spurious()</span></code>.</p></li>
</ul>
<p><strong>Vai trò của Dịch vụ ngắt chung ``_isr_wrapper()``:</strong></p>
<ul class="simple">
<li><p>Đây là hàm đầu tiên được gọi khi một ngắt được kích hoạt. Nó có trách nhiệm trích xuất địa chỉ và các tham số liên quan từ <strong>bảng Vector Ngắt phần mềm</strong>, sau đó chuyển quyền điều khiển tới hàm xử lý ngắt tương ứng.</p></li>
</ul>
<p><strong>Ngắt trực tiếp:</strong></p>
<ul class="simple">
<li><p>Đây là loại ngắt được kết nối trực tiếp với <strong>bảng Vector Ngắt phần cứng</strong>. Khi một ngắt trực tiếp được kích hoạt, hàm xử lý ngắt tương ứng được thực thi ngay lập tức mà không thông qua bất kỳ phương tiện trung gian nào</p></li>
</ul>
<p>Dưới đây là Logic việc đăng ký dịch vụ ngắt:</p>
<a class="reference internal image-reference" href="../_images/hw_table.png"><img alt="hw_table" src="../_images/hw_table.png" style="width: 100%;" /></a>
</section>
<section id="ngat-thong-thuong-regular-interrupt">
<h2><a class="toc-backref" href="#id10" role="doc-backlink">Ngắt Thông thường - Regular Interrupt</a><a class="headerlink" href="#ngat-thong-thuong-regular-interrupt" title="Link to this heading"></a></h2>
<p>Được tạo bởi hàm <code class="docutils literal notranslate"><span class="pre">IRQ_CONNECT()</span></code>, sau đó phải được kích hoạt bằng cách gọi hàm <code class="docutils literal notranslate"><span class="pre">irq_enable()</span></code></p>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p><strong>Ngắt Thông thường được tạo ngay khi biên dịch chương trình</strong></p>
</div>
<div class="admonition attention">
<p class="admonition-title">Chú ý</p>
<p><code class="docutils literal notranslate"><span class="pre">IRQ_CONNECT()</span></code> bản thân nó không phải là một hàm C, không thao tác bên trong hàm. Vì vậy, tất cả đối số của nó cần phải được cung cấp ngay thời điểm gọi.</p>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">IRQ_CONNECT</span><span class="p">(</span><span class="n">irq_p</span><span class="p">,</span><span class="w"> </span><span class="n">priority_p</span><span class="p">,</span><span class="w"> </span><span class="n">isr_p</span><span class="p">,</span><span class="w"> </span><span class="n">isr_param_p</span><span class="p">,</span><span class="w"> </span><span class="n">flags_p</span><span class="p">)</span>
</pre></div>
</div>
<p>Trong đó</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">irq_p</span>                  <span class="o">&lt;</span><span class="n">Số</span> <span class="n">hiệu</span> <span class="n">của</span> <span class="n">ngắt</span><span class="o">/</span><span class="n">Số</span> <span class="n">hiệu</span> <span class="n">đăng</span> <span class="n">kí</span> <span class="n">thiết</span> <span class="n">bị</span><span class="o">&gt;</span>
<span class="n">priority_p</span>                     <span class="o">&lt;</span><span class="n">Ưu</span> <span class="n">tiên</span> <span class="n">của</span> <span class="n">ngắt</span><span class="o">/</span><span class="n">Mức</span> <span class="n">ưu</span> <span class="n">tiên</span><span class="o">&gt;</span>
<span class="n">isr_p</span>                               <span class="o">&lt;</span><span class="n">Hàm</span> <span class="n">dịch</span> <span class="n">vụ</span> <span class="n">ngắt</span><span class="o">&gt;</span>
<span class="n">flags_p</span>                 <span class="o">&lt;</span><span class="n">Cờ</span> <span class="n">ngắt</span><span class="p">[</span><span class="n">Không</span> <span class="n">phải</span> <span class="n">là</span> <span class="n">cờ</span> <span class="n">xác</span> <span class="n">định</span> <span class="n">ngắt</span><span class="p">]</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Một ví dụ về khởi tạo Ngắt Thông thường như sau:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MY_DEV_IRQ 24 </span><span class="cm">/* Thiết bị sử dụng IRQ #24 */</span>
<span class="cp">#define MY_DEV_PRIO 2 </span><span class="cm">/* Mức ưu tiên của ngắt là 2 */</span>
<span class="cm">/* Đối số trỏ tới thiết bị*/</span>
<span class="cp">#define MY_ISR_ARG DEVICE_GET(my_device)</span>
<span class="cp">#define MY_IRQ_FLAGS 0 </span><span class="cm">/* Cờ IRQ - Tính chất của Ngắt */</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">my_isr</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="p">...</span><span class="w"> </span><span class="cm">/* Dịch vụ Ngắt */</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">my_isr_installer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="p">...</span>
<span class="w">   </span><span class="n">IRQ_CONNECT</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">,</span><span class="w"> </span><span class="n">MY_DEV_PRIO</span><span class="p">,</span><span class="w"> </span><span class="n">my_isr</span><span class="p">,</span><span class="w"> </span><span class="n">MY_ISR_ARG</span><span class="p">,</span><span class="w"> </span><span class="n">MY_IRQ_FLAGS</span><span class="p">);</span>
<span class="w">   </span><span class="n">irq_enable</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">);</span>
<span class="w">   </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Với phương pháp tạo Ngắt trên, ngắt lúc nào cũng sẽ được khai báo ngay sau khi biên dịch (nằm trong tập tin <code class="docutils literal notranslate"><span class="pre">Config</span></code>). Đương nhiên, Zephyr cũng hỗ trờ đăng ký bằng cách gọi hàm <code class="docutils literal notranslate"><span class="pre">irq_connect_dynamic()</span></code> trong thời gian chạy, nhưng <code class="docutils literal notranslate"><span class="pre">CONFIG_DYNAMIC_INTERRUPTS=y</span></code> cần được bật.</p>
</section>
<section id="ngat-truc-tiep-direct-interrupt">
<h2><a class="toc-backref" href="#id11" role="doc-backlink">Ngắt Trực tiếp - Direct Interrupt</a><a class="headerlink" href="#ngat-truc-tiep-direct-interrupt" title="Link to this heading"></a></h2>
<p>Các Ngắt Thông thường trong Zephyr vẫn chịu một số giới hạn của Kernel, kèm theo đó vẫn có độ trễ xử lý nhất định, khó có thể chấp nhận được với một số trường hợp yêu cầu phản ứng thời gian thực:</p>
<ul class="simple">
<li><p>Tham số đầu vào ISR được chuyển thẳng đến ISR</p></li>
<li><p>Nếu có sử dụng <strong>Power Management</strong>, khi hệ thống đang ở trạng thái chờ, tất cả phần cứng sẽ cần phải được đánh thức trước khi ISR được thực thi, điều này đối với Ngắt Thông thường khó đạt được.</p></li>
<li><p>Một số kiến trúc yêu cầu cần có <strong>Interrupt Stack</strong>, nhưng một số kiến trúc khác lại có thể xử lý điều này chỉ cần phần cứng</p></li>
<li><p>Sau khi phục vụ Ngắt, OS cần phải thực hiện một số Logic để có thể lập lịch lại tiến trình.</p></li>
</ul>
<p>Vì vậy, Zephyr hỗ trợ các ngắt được gọi là <strong>Direct</strong>, được cài đặt thông qua <code class="docutils literal notranslate"><span class="pre">IRQ_DIRECT_CONNECT()</span></code>. Những Ngắt Trực tiếp được này có yêu cầu một số cài đặt đặc biệt, phần cứng hỗ trợ và một số tính năng bị lược bớt so với Ngắt Thông thường.</p>
<div class="admonition tip">
<p class="admonition-title">Mẹo</p>
<p>Xem thêm: <a class="reference external" href="https://docs.zephyrproject.org/latest/kernel/services/interrupts.html#c.IRQ_DIRECT_CONNECT">Direct Interrupt</a></p>
</div>
<p>Có thể nói cách khác, <code class="docutils literal notranslate"><span class="pre">IRQ_DIRECT_CONNECT()</span></code> thường được sử dụng cho các Ngắt phần cứng, trong khi <code class="docutils literal notranslate"><span class="pre">IRQ_CONNECT()</span></code> thường được sử dụng cho các ngắt mềm. <code class="docutils literal notranslate"><span class="pre">IRQ_DIRECT_CONNECT()</span></code> có thể cung cấp hiệu suất tốt hơn trong một số trường hợp, đặc biệt là khi cần đạt được thời gian đáp ứng thấp hơn và giảm thiểu độ trễ.</p>
<p>Một ví dụ khởi tạo <strong>Ngắt Trực tiếp</strong> tương tự ví dụ trước:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define MY_DEV_IRQ 24 </span><span class="cm">/* Thiết bị đăng ký IRQ #24 */</span>
<span class="cp">#define MY_DEV_PRIO 2 </span><span class="cm">/* Mức ưu tiên 2 */</span>
<span class="cm">/* Đối số là một con trỏ tới thiết vị */</span>
<span class="cp">#define MY_IRQ_FLAGS 0 </span><span class="cm">/* Cờ IRQ */</span>

<span class="n">ISR_DIRECT_DECLARE</span><span class="p">(</span><span class="n">my_isr</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="n">do_stuff</span><span class="p">();</span>
<span class="w">   </span><span class="n">ISR_DIRECT_PM</span><span class="p">();</span><span class="w"> </span><span class="cm">/* PowerManagement được thực hiện sau khi ngắt dịch vụ để có độ trễ tốt nhất */</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="n">my_isr_installer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="p">...</span>
<span class="w">   </span><span class="n">IRQ_DIRECT_CONNECT</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">,</span><span class="w"> </span><span class="n">MY_DEV_PRIO</span><span class="p">,</span><span class="w"> </span><span class="n">my_isr</span><span class="p">,</span><span class="w"> </span><span class="n">MY_IRQ_FLAGS</span><span class="p">);</span>
<span class="w">   </span><span class="n">irq_enable</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">);</span>
<span class="w">   </span><span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ngat-co-do-tre-bang-0-zero-latency-interrupt">
<h2><a class="toc-backref" href="#id12" role="doc-backlink">Ngắt có độ trễ bằng 0 - Zero Latency Interrupt</a><a class="headerlink" href="#ngat-co-do-tre-bang-0-zero-latency-interrupt" title="Link to this heading"></a></h2>
<p>Như đã đề cập trước đó, loại ngắt thứ 3 này có thể là <strong>Ngắt Trực tiếp</strong> hoặc là <strong>Ngắt Thông thường</strong>. Nói một cách khác, cách triển khai của nó tương tự như hai loại trên, điểm khác biệt duy nhất là Cờ Ngắt <code class="docutils literal notranslate"><span class="pre">flags_q</span></code> được truyền vào là <code class="docutils literal notranslate"><span class="pre">IRQ_ZERO_LATENCY</span></code>, để chỉ ra rằng, đây là một Ngắt được khởi tạo với tính chất không có độ trễ.</p>
<p><strong>Tại sao lại gọi là không có độ trễ?</strong></p>
<p>Cơ bản là trong quá trình thiết kế chương trình, chúng ta thường mặc định có khóa ngắt trong Code, để đảm bảo rằng Code sẽ không bị chồng chập, gián đoạn bởi Ngắt. Tuy nhiên, điều này có thể dẫn đến việc tăng độ trễ của hệ thống, điều này thường không chấp nhận được đối với một số trường hợp ứng dụng đòi hỏi thời gian phản hồi thấp.</p>
<p>Ở đây, vai trò của <strong>Ngắt không độ trễ</strong> được thể hiện. Nó chạy ở một ưu tiên không bị khóa, tất nhiên cần bật <code class="docutils literal notranslate"><span class="pre">CONFIG_ZERO_LATENCY_IRQS=y</span></code> để kích hoạt. Như vậy, khi một ngắt được kích hoạt, hàm xử lý ngắt tương ứng có thể được thực thi ngay lập tức, giảm đáng kể độ trễ của ngắt.</p>
<hr class="docutils" />
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p><strong>Dựa trên các Ngắt Tổng quát trên, Zephyr cung cấp các API của các Ngắt Ứng dụng, được tạo nên bởi các hàm trên, bao gồm:</strong></p>
<ul class="simple">
<li><p><strong>Ngắt Ngoại vi [GPIO, Sensor,v.v..]</strong></p></li>
<li><p><strong>Ngắt Timer</strong></p></li>
<li><p><strong>Ngắt UART</strong></p></li>
</ul>
<p><strong>Và một số Ngắt đặc biệt khác như WatchDog, ADC, v.v.</strong></p>
</div>
</section>
<section id="ung-dung-ngat-ngoai-vi-gpio">
<h2><a class="toc-backref" href="#id13" role="doc-backlink">Ứng dụng - Ngắt Ngoại vi - GPIO</a><a class="headerlink" href="#ung-dung-ngat-ngoai-vi-gpio" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Xem: <a class="reference external" href="./gpio_interrupt.html">GPIO Interrupt</a></p>
</div>
</section>
<section id="ung-dung-ngat-timer">
<h2><a class="toc-backref" href="#id14" role="doc-backlink">Ứng dụng - Ngắt Timer</a><a class="headerlink" href="#ung-dung-ngat-timer" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Xem: <a class="reference external" href="./timer_interrupt.html">Timer Interrupt</a></p>
</div>
</section>
<section id="ung-dung-ngat-uart">
<h2><a class="toc-backref" href="#id15" role="doc-backlink">Ứng dụng - Ngắt UART</a><a class="headerlink" href="#ung-dung-ngat-uart" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Xem: <a class="reference external" href="./uart_interrupt.html">UART Interrupt</a></p>
</div>
</section>
<section id="vo-hieu-hoa-mot-ngat">
<h2><a class="toc-backref" href="#id16" role="doc-backlink">Vô hiệu hóa một Ngắt</a><a class="headerlink" href="#vo-hieu-hoa-mot-ngat" title="Link to this heading"></a></h2>
<p>Trong một số tình huống, có thể cần thiết cho Thread hiện tại ngăn không cho ISRs (Interrupt Service Routines - các hàm xử lý ngắt) thực thi, bởi nó đang thực hiện các hoạt động đòi hỏi thời gian chính xác hoặc phần quan trọng. Một Thread có thể tạm thời ngăn tất cả các xử lý IRQ trong hệ thống bằng cách sử dụng một khóa IRQ. Khóa này có thể được áp dụng ngay cả khi nó đã hoạt động, do đó các hàm có thể sử dụng nó mà không cần biết nó đã hoạt động hay chưa. Thread phải mở khóa IRQ của mình cùng số lần đã khóa trước khi ngắn này có thể được xử lý lại bởi Kernel trong khi Thread đang chạy.</p>
<div class="admonition attention">
<p class="admonition-title">Chú ý</p>
<p>Khóa IRQ là cụ thể cho từng Thread.</p>
<p>Nếu Thread A khóa ngắt sau đó thực hiện một hoạt động cho phép Thread B chạy (ví dụ: cung cấp một semaphore hoặc ngủ trong N mili giây), thì khóa IRQ của Thread không còn áp dụng sau khi Thread A được đổi ra. Điều này có nghĩa là các ngắt có thể được xử lý trong khi Thread B đang chạy trừ khi Thread B cũng đã khóa ngắt bằng khóa IRQ riêng của mình. Khi Thread A trở thành Thread hiện tại một lần nữa, Kernel tái thiết lập khóa IRQ của Thread A.
Điều này đảm bảo Thread A sẽ không bị gián đoạn cho đến khi nó đã mở khóa IRQ của mình một cách rõ ràng.</p>
</div>
<p>Nói cách khác, một Thread có thể tạm thời vô hiệu hóa một IRQ cụ thể. IRQ phải được kích hoạt sau đó để cho phép ISR thực thi.</p>
<div class="admonition hint">
<p class="admonition-title">Gợi ý</p>
<p>Vô hiệu hóa một IRQ, điều này ngăn tất cả các Thread trong hệ thống bị gián đoạn bởi ISR liên quan, không chỉ là Thread đã vô hiệu hóa IRQ.</p>
</div>
</section>
<section id="cac-api-thuong-gap">
<h2><a class="toc-backref" href="#id17" role="doc-backlink">Các API thường gặp</a><a class="headerlink" href="#cac-api-thuong-gap" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Xem: <a class="reference external" href="./command.html">API Thường gặp</a></p>
</div>
</section>
<section id="thuc-hanh">
<h2><a class="toc-backref" href="#id18" role="doc-backlink">Thực hành</a><a class="headerlink" href="#thuc-hanh" title="Link to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Ghi chú</p>
<p>Xem: <a class="reference external" href="./exercise.html">Thực hành</a></p>
</div>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p><em>Là một Thread trong hệ thống mà được sử dụng để xử lý công việc bổ
sung mà không cần phải chạy trong ISR. Thường thì các Thread này có
độ ưu tiên thấp hơn so với Thread chính để tránh làm gián đoạn quá
trình chính quá nhiều.</em></p>
</aside>
</aside>
</section>
<section id="lien-ket">
<h2><a class="toc-backref" href="#id19" role="doc-backlink">Liên kết</a><a class="headerlink" href="#lien-ket" title="Link to this heading"></a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="gpio_interrupt.html">Ngắt Ngoại vi GPIO - External Interrupt GPIO</a><ul>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#tom-tat-phan-cung">Tóm tắt phần cứng</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#tong-quan-ve-gpio">Tổng quan về GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#phan-tich-device-tree">Phân tích Device Tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#cac-cau-truc-du-lieu-lien-quan-den-devicetree">Các cấu trúc dữ liệu liên quan đến DeviceTree</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#khoi-tao-thiet-bi">Khởi tạo thiết bị</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#su-dung-api-gpio">Sử dụng API GPIO</a></li>
<li class="toctree-l2"><a class="reference internal" href="gpio_interrupt.html#ngat-gpio">Ngắt GPIO</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="uart_interrupt.html">Ngắt UART</a><ul>
<li class="toctree-l2"><a class="reference internal" href="uart_interrupt.html#tong-quan">Tổng quan</a></li>
<li class="toctree-l2"><a class="reference internal" href="uart_interrupt.html#tong-quan-ngat-uart">Tổng quan Ngắt UART</a></li>
<li class="toctree-l2"><a class="reference internal" href="uart_interrupt.html#mot-so-ham-lien-quan">Một số hàm liên quan</a></li>
<li class="toctree-l2"><a class="reference internal" href="uart_interrupt.html#phuong-phap-co-ban">Phương pháp cơ bản</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="timer_interrupt.html">Ngắt Timer</a></li>
<li class="toctree-l1"><a class="reference internal" href="command.html">Các API thường gặp</a></li>
<li class="toctree-l1"><a class="reference internal" href="exercise.html">Thực hành</a><ul>
<li class="toctree-l2"><a class="reference internal" href="exercise.html#bang-vector-ngat-ex-vector">1. Bảng Vector Ngắt - ex_vector</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercise.html#kich-hoat-mot-ngat-ex-trigger">2. Kích hoạt một Ngắt - ex_trigger</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercise.html#zero-latency-interrupt-ex-zerolatency">3. Zero Latency Interrupt - ex_zerolatency</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercise.html#ngat-gpio-ex-gpioisr">4. Ngắt GPIO - ex_gpioisr</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercise.html#ngat-uart-ex-uartisr">5. Ngắt UART - ex_uartisr</a></li>
</ul>
</li>
</ul>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../6.I2C/exercise/ex1/readme.html" class="btn btn-neutral float-left" title="Exercise 1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="gpio_interrupt.html" class="btn btn-neutral float-right" title="Ngắt Ngoại vi GPIO - External Interrupt GPIO" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Bao Bui.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>